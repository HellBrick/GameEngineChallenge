### Дополнительные цели дизайна апишек движка

1. Минимизировать количество first-class сущностей.
Например, то что юнит умирает при падении HP до 0 - это всего лишь одна из абилок героя.
И само понятие смерти вместе с её последствиями - это абилка.
И механика передвижения под воздействием инпута.
И т.д.

1. Сделать так, чтобы добавление новых абилок, как-то расширяющих механику действия уже существующих абилок, не требовало модификации расширяемых абилок.
Иначе с ростом кол-ва подобных фич всё превратится в адскую кашу.

### Базовые сущности и механика их взаимодействия

1. У героев есть динамический набор реквизитов (`IRequisite`), которые могут реализовывать один из нескольких поддерживаемых движком интерфейсов.
1. Основной вид реквизита - это активная абилка (`IActiveAbility`), она генерирует от произвольное количество (от 0 до N) действий (`IAction`). Сами абилки при этом стейт игры не модифицируют.
1. Действие может вносить любые изменения в стейт игры.
1. Взаимодействие между абилками реализуется с помощью реквизитов-интерсепторов (`IActionInterceptor`).
Каждое выполняемое движком действие прогоняется через все имеющиеся у героя интерсепторы, и каждый интерсептор может трансформировать его в набор действий.
Это позволяет как добавлять к действиям других абилок дополнительные эффекты (Invoke reload slowdown и т.д.), так и блокировать какие-то из действий (в частности, так работает смерть - она отключает все действия юнита).
1. Тик рабит на упорядоченные фазы, и каждая активная абилка отнесена к какой-то фазе.
1. `TickExecutor` выполняет каждую фазу следующим образом:
   1. Собирает со всех активных абилок всех героев действия для выполнения.
   1. Прогоняет набор действий через интерсепторы, получая финальный набор действий.
   1. Выполняет все действия фазы.
1. `Simulation` - это раннер полной симуляции, который замеряет время между тиками, выполняет их с помощью `TickExecutor`-а и останавливается при наступлении заданного условия конца игры.

### Мысли по дальнейшему развитию

Задачка классная, но очень open-ended: дорабатывать её можно вечно =) Так как где-то поставить точку нужно, хочу озвучить ряд мыслей по дальнейшей доработке.

#### Производительность

На текущих объёмах всё замечательно, но если сделать кол-во одновременно сражающихся героев и/или используемых в каждый момент времени абилок достаточно большим, всплывёт несколько оптимизационных моментов:

1. Аллокации, начнёт кусаться GC. Я сразу собрал low-hanging fruit в интерсепторах, но мелких аллокаций сейчас довольно много, и при масштабировании на что-то серьёзное от них нужно будет избавиться. Классический linq нужно будет заменить на неаллоцирующие immutable итераторы, а массивы объектов и создаваемые действия нужно будет пулить и переиспользовать. Чёткая цикличность процесса симуляции позволяет довольно удобно пулить что угодно, т.к. мы точно знаем, что все временные объекты, нужные во время выполнения тика, по окончанию тика можно спокойно вернуть в пул.
1. Куча double арифметики с рассчётом расстояний между юнитами. При большом количестве юнитов скорее всего придётся вводить более частные оптимизированные апишки и умным образом кэшировать результаты их вызовов.
1. Параллелизм - поскольку все активные абилки чистые, расчёт их действий внутри фазы можно при необходимости параллелить.

На текущих небольших объёмах в симуляции верхнего уровня есть другая минорная проблема: тики просчитываются слишком быстро, и мы прожигаем на ненужных частых пересчётах довольно много проца. Есть мысль выделить `ITickExecutor` и сделать для него декоратор, лимитирующий частоту расчёта тиков.

#### Расширение движка

Сейчас интерсепторы позволяют перехватывать только действия, порождённые владельцем интерсептора.
Можно добавить поддержку "защитных" интерсепторов, собираемых с целей действий, это откроет большое кол-во новых возможностей по созданию абилок.

Помимо этого, рано или поздно серьёзно встанет вопрос со stacking abilities, и нужно будет сделать инфраструктуру для поддержки разного вида стекования абилок.

Ну и конечно надо подумать над тулингом для создания абилок и героев, чтобы отдать максимальное количество возможностей геймдизайнерам.
